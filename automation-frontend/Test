---
- hosts: localhost
  gather_facts: false
  vars_files:
    - /home/deploymentvm/Desktop/Automation_frontend/IaC-Automated-Network-Server-Deployment-for-Menards/automation-frontend/vars.yaml

  tasks:

  - name: Create VM on ESXi
    community.vmware.vmware_guest:
      validate_certs: false
      hostname: "{{ esxi.hostname }}"
      username: "{{ esxi.username }}"
      password: "{{ esxi.password }}"
      datacenter: "{{ esxi.datacenter }}"
      folder: "/vm/"
      name: "{{ vm_name }}"
      state: poweredoff
      guest_id: "{{ 'windows9Server64Guest' if os == 'Windows' else 'ubuntu64Guest' }}"
      disk:
        - size_gb: "{{ storage }}"
          type: thin
          datastore: VMs
      hardware:
        memory_mb: "{{ memory | int * 1024 }}"   # Convert GB to MB
        num_cpus: "{{ cpu }}"
      networks:
        - name: VLAN30 - host VMs
          dns_servers: 10.0.1.50
          type: dhcp
      cdrom:
        - controller_number: 0
          unit_number: 0
          state: present 
          type: iso
          iso_path: >-
            {{ '[VMs] Windows Files/windows-server.iso' if os == 'Windows' else '[VMs] Ubuntu Files/ubuntu-24.04.2-live-server-amd64.iso' }}
    delegate_to: localhost

  - name: Calculate VM expiration time
    set_fact:
      deletion_time: "{{ '%Y-%m-%d %H:%M:%S' | strftime('%s') | int + 86400 }}"

  - name: Schedule VM deletion task (example)
    ansible.builtin.command:
      cmd: echo "/usr/bin/ansible-playbook delete_vm.yaml" | at now + 1 day
    delegate_to: localhost
