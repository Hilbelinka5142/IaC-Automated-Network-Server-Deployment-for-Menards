import os
import json
import yaml
import glob
from datetime import datetime
import subprocess

# Path to your JSON requests folder
REQUESTS_DIR = '/home/deploymentvm/Desktop/Automation_frontend/IaC-Automated-Network-Server-Deployment-for-Menards/automation-frontend/requests'
VARS_YAML_PATH = os.path.join(REQUESTS_DIR, 'vars.yaml')

# Get all JSON request files sorted by modified time (newest last)
json_files = sorted(
    glob.glob(os.path.join(REQUESTS_DIR, 'request_*.json')),
    key=os.path.getmtime,
    reverse=True
)

if not json_files:
    print("‚ùå No VM request files found.")
    exit(1)

latest_file = json_files[0]

# Load and show the latest request
with open(latest_file, 'r') as f:
    data = json.load(f)

print(f"‚úÖ Loaded latest request: {os.path.basename(latest_file)}")
print(json.dumps(data, indent=4))

# Save request data as vars.yaml (for Ansible)
with open(VARS_YAML_PATH, 'w') as f:
    yaml.dump(data, f)

print(f"üìÅ Saved request variables to: {VARS_YAML_PATH}")

# Optional: Trigger the Ansible playbook
ansible_command = [
    'ansible-playbook',
    'deploy_vm.yml',
    '--extra-vars',
    f"@{VARS_YAML_PATH}"
]

print("üöÄ Running Ansible playbook...")
subprocess.run(ansible_command)
